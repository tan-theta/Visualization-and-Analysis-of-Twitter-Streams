<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spain_map</title>

	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="//unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
	<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>


	<style type="text/css">
		.feature {
			fill: none;
			stroke: grey;
			stroke-width: 1px;
			stroke-linejoin: round;
		}
		.mesh {
			fill: none;
			stroke: lightgrey;
			stroke-width: 2px;
			stroke-linejoin: round;
		}
		h1 {
			font-family: sans-serif;
		}

		.center {
			margin: auto;
			padding: 10px;
			width : 80%;
			height: 50%;
		}

		h1{
			font-family: 'Raleway', sans-serif;
			font-weight: 700;
		}

	</style>
</head>
<body>

	<h1>Sentiment Analysis  - Provincial Spain </h1>

	<div class="container">
		<div class="col-sm">
			<div class ="center" id="svgDiv"></div>

			<div class="col-sm">
				<div class = "center" id="pieDiv"></div>
			</div>
		</div>

		<script type="text/javascript">

			var w = window.innerWidth;
			var h = window.innerHeight - 300;

			var width = w,
			height = h;

// set projection
var projection = d3.geoMercator();

// create path variable
var path = d3.geoPath()
.projection(projection);

//sentiment color scale	
var color_scale = d3.scaleLinear()
.domain([-1, 0, 1])
.range(["red", "white", "green"]);	

// create svg variable
var svg = d3.select("#svgDiv").append("svg")
.attr("width", width)
.attr("height", height);

// Color legend.
var legend = d3.legendColor()
.scale(color_scale)
.title("Tweet Sentiment")
.labels(["Very Negative", "Negative", "Neutral", "Positive", "Very Positive"]);

svg.append("g")
.attr("transform", "translate(1200,450)")
.call(legend);


d3.json("spain.json").then(function(topo) {

	//console.log(topo);

	states = topojson.feature(topo, topo.objects.ESP_adm2).features

  	// set projection parameters
  	projection
  	.scale(3000)
  	.center([0, 40])
  	.translate([width / 2, height / 2]);


	// add states from topojson
	svg.selectAll("path")
	.data(states).enter()
	.append("path")
	.attr("class", "feature")
	.style("fill", "rgb(230,230,230)")
	.attr("d", path);


    // put border around states 
    svg.append("path")
    .datum(topojson.mesh(topo, topo.objects.ESP_adm2, function(a, b) { return a !== b; }))
    .attr("class", "mesh")
    .attr("d", path);

	// function to draw circles
	function update_circles_spain(src){
		var data_t = []
		d3.csv(src ,function(d){
			d['Latitude'] = +d['Latitude']
			d['Longitude'] = +d['Longitude']
			d['sentiment'] = +d['sentiment']
			data_t.push([d['Longitude'], d['Latitude'], d['sentiment']]);


			svg.selectAll("circle")
			.data(data_t).enter()
			.append("circle")
			.attr("cx", function (d) { return projection(d)[0]; })
			.attr("cy", function (d) { return projection(d)[1]; })
			.attr("r", "8px")
			.attr("fill", function(d){color = color_scale(d[2]); return color; } )
			.attr("fill-opacity", 0.7)
		});
	}


	var count = 1;

	update_circles_spain("data/extension/clean_spain_0.csv");

	 	var delayInMilliseconds = 10; //5 seconds

		var count = 1;                  //  set your counter to 1

		function myLoop () {            //  create a loop function
			setTimeout(function () {   

				svg.selectAll("circle").remove();   

				var src_string = "data/extension/clean_spain_"+ count +".csv";

				count++;  

			 	//console.log(src_string);    

			 	update_circles_spain(src_string);

			    if (count < 8) {         //  if the counter < number of datasets, call the loop function
			    	myLoop();            //    again which will trigger another 
			    }
			    else{
			    	count = 0;
			    	myLoop();
			    }                        
			}, delayInMilliseconds)
		}

		myLoop();  


	}).catch(function(error){
	//handle error
	//console.log(error);
});




</script>

</body>
</html>